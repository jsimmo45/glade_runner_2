<!DOCTYPE html>
<html>
<head>
  <title>Ryan Simmons' Glade Runner 2</title>
  <style>
    body {
      margin: 0;
      background-color: #f0f0f0;
      font-family: sans-serif;
      text-align: center;
    }
    /* Progress bar container (placed above the play area) */
    #progressContainer {
      width: 1600px;
      height: 20px;
      margin: 10px auto;
      background: #ddd;
      border: 2px solid #333;
      display: none;
    }
    #progressBar {
      width: 0%;
      height: 100%;
      background: #4CAF50;
    }
    /* Canvas: play area now 1600x1200 */
    canvas {
      width: 1600px;
      height: 1200px;
      background: #fff;
      border: 5px solid #333;
      display: block;
      margin: 20px auto;
    }
    /* Button styling */
    button {
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 15px 32px;
      margin: 10px;
      font-size: 18px;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: background-color 0.3s, transform 0.2s;
    }
    button:hover {
      background-color: #45a049;
      transform: scale(1.02);
    }
    /* Common UI containers */
    #menu, #playerSelect, #soundtrackMenu, #endMenu, #pauseMenu, #introMovie, #highScorePanel {
      text-align: center;
      margin-top: 20px;
    }
    /* Character selection: show each skier with stats on separate rows */
    #playerSelect div {
      display: inline-block;
      margin: 0 20px;
    }
    #playerSelect img {
      width: 100px;
      height: 100px;
      display: block;
      margin: 0 auto 5px;
    }
    #playerSelect p {
      margin: 5px 0;
      font-size: 18px;
      color: #333;
    }
    #timer {
      font-size: 24px;
      margin-top: 10px;
    }
    /* High score input styling */
    #highScorePanel input[type="text"] {
      padding: 8px;
      font-size: 16px;
      width: 200px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #highScorePanel button {
      padding: 8px 16px;
      font-size: 16px;
    }
    #highScoreList {
      margin-top: 10px;
      text-align: left;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
  </style>
</head>
<body>
  <!-- Main Menu -->
  <div id="menu">
    <img id="titleImage" src="title-screen.png" alt="Title Screen">
    <br>
    <button id="viewMovieButton">View Intro Movie</button>
    <br>
    <!-- Stage selection buttons -->
    <button id="stage1Button">Forest Frenzy</button>
    <button id="stage2Button">Winter Wonderland</button>
    <button id="stage3Button">Mountain Madness</button>
    <button id="stage4Button">Rockslide Rumble</button>
    <button id="bunnyButton">Bunny Slope Blitz</button>
    <button id="serpentineButton">Serpentine Slalom</button>
    <br>
    <!-- Soundtrack option -->
    <button id="soundtrackButton">Soundtrack</button>
  </div>
  
  <!-- Soundtrack Menu -->
  <div id="soundtrackMenu" style="display:none;">
    <h2>Soundtrack</h2>
    <button id="playTitleMusic">Escape the Murder Tree</button>
    <button id="playStage1Music">Murder Tree Behind You</button>
    <button id="playStage2Music">Murder Tree Breakdown</button>
    <button id="playStage3Music">Stage 3 Music</button>
    <br>
    <button id="backToMenuFromSoundtrack">Back to Menu</button>
  </div>
  
  <!-- Character Selection (with four skiers) -->
  <div id="playerSelect" style="display:none;">
    <h2>Select Your Skier</h2>
    <div>
      <img id="ryanRight" src="ryan-right.png" alt="Ryan">
      <p>Speed: 2</p>
      <p>Stamina: 1</p>
      <p>Steeze: 3</p>
      <button id="player1Button">Ryan</button>
    </div>
    <div>
      <img id="alexRight" src="alex-right.png" alt="Alex">
      <p>Speed: 3</p>
      <p>Stamina: 2</p>
      <p>Steeze: 1</p>
      <button id="player2Button">Alex</button>
    </div>
    <div>
      <img id="mitchRight" src="mitch-right.png" alt="Mitch">
      <p>Speed: 1</p>
      <p>Stamina: 3</p>
      <p>Steeze: 2</p>
      <button id="player3Button">Mitch</button>
    </div>
    <div>
      <img id="jeremyRight" src="jeremy-right.png" alt="Jeremy">
      <p>Speed: 2</p>
      <p>Stamina: 2</p>
      <p>Steeze: 2</p>
      <button id="player4Button">Jeremy</button>
    </div>
  </div>
  
  <div id="pauseMenu" style="display:none;">
    <button id="pauseButton">Pause</button>
  </div>
  
  <div id="endMenu" style="display:none;">
    <p id="timeTaken"></p>
    <img id="endImage" src="" alt="End Image"><br>
    <div id="highScorePanel">
      <input type="text" id="playerName" placeholder="Enter your name">
      <button id="submitScoreButton">Submit Score</button>
      <br>
      <button id="viewHighScoresButton">View High Scores</button>
    </div>
    <div id="highScoreList"></div>
    <br>
    <button id="restartButton">Restart Game</button>
  </div>
  
  <div id="introMovie" style="display:none;">
    <video id="introVideo" width="1600" height="1200" controls>
      <source src="intro-movie.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>
  
  <!-- Progress bar (above play area) -->
  <div id="progressContainer" style="display:none;">
    <div id="progressBar"></div>
  </div>
  
  <!-- Game Canvas (1600x1200) -->
  <canvas id="gameCanvas" width="1600" height="1200" style="display:none;"></canvas>
  <div id="timer">Time: 0 seconds</div>

  <!-- Audio Elements -->
  <audio id="titleMusic" loop>
    <source src="Escape_the_Murder_Tree.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  <audio id="stage1Music" loop>
    <source src="Murder_Tree_Behind_You.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  <audio id="stage2Music" loop>
    <source src="Murder_Tree_Breakdown.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  <audio id="stage3Music" loop>
    <source src="stage3-music.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <script>
    console.log("Script loaded");

    // Canvas dimensions
    const cw = 1600, ch = 1200;

    /* ---------------- Character Stats ---------------- */
    const characterStats = {
      ryan: { speedMultiplier: 2.0, stamina: 1, steeze: 3 },
      alex: { speedMultiplier: 3.0, stamina: 2, steeze: 1 },
      mitch: { speedMultiplier: 1.0, stamina: 3, steeze: 2 },
      jeremy: { speedMultiplier: 2.0, stamina: 2, steeze: 2 }
    };

    /* ---------------- Additional Game States ---------------- */
    const GAME_STATES = {
      MENU: 'menu',
      PLAYER_SELECT: 'player_select',
      INTRO: 'intro',
      PLAYING: 'playing',
      PAUSED: 'paused',
      GAME_OVER: 'game_over',
      WIN: 'win'
    };

    // Stage IDs â€“ note: we now add a new stage "Serpentine Slalom"
    const STAGES = {
      STAGE1: 1,
      STAGE2: 2,
      STAGE3: 3,
      STAGE4: 4,
      BUNNY: 5,
      SERPENTINE: 6
    };

    // AABB collision check
    function checkCollision(a, b) {
      return a.x < b.x + b.width &&
             a.x + a.width > b.x &&
             a.y < b.y + b.height &&
             a.y + a.height > b.y;
    }

    // Load an image and return a Promise
    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          console.log(`Loaded image: ${src}`);
          resolve(img);
        };
        img.onerror = () => {
          console.error(`Error loading image: ${src}`);
          reject();
        };
        img.src = src;
      });
    }

    /* ---------------- SnowFlake (for Stage 2) ---------------- */
    class SnowFlake {
      constructor(x, y, size, speed, drift) {
        this.x = x;
        this.y = y;
        this.size = size;
        this.speed = speed;
        this.drift = drift;
      }
      update() {
        this.y += this.speed;
        this.x += this.drift;
        if (this.y > ch) {
          this.y = -this.size;
          this.x = Math.random() * cw;
        }
        if (this.x > cw) { this.x = 0; }
        if (this.x < 0) { this.x = cw; }
      }
      draw(ctx) {
        ctx.fillStyle = 'rgba(200,200,200,0.8)';
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    /* ---------------- Entity Classes ---------------- */
    class Skier {
      constructor(x, y, width, height, images) {
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
        this.baseSpeed = 6;
        this.speed = this.baseSpeed;
        this.direction = 'forward';
        this.images = images;
        this.boostActive = false;
        this.boostEndTime = 0;
        this.lastHitTime = 0;
        this.stamina = 1;
        this.steeze = 1;
      }
      update(keys, canvasWidth, canvasHeight) {
        if (keys.ArrowLeft) { this.x -= this.speed; this.direction = 'left'; }
        if (keys.ArrowRight) { this.x += this.speed; this.direction = 'right'; }
        if (keys.ArrowUp) { this.y -= this.speed; this.direction = 'forward'; }
        if (keys.ArrowDown) { this.y += this.speed; this.direction = 'forward'; }
        this.x = Math.max(0, Math.min(this.x, canvasWidth - this.width));
        this.y = Math.max(0, Math.min(this.y, canvasHeight - this.height));
        if (this.boostActive && Date.now() > this.boostEndTime) {
          this.speed = this.baseSpeed;
          this.boostActive = false;
          console.log("Speed boost ended");
        }
      }
      draw(ctx) {
        let img;
        if (this.direction === 'left') {
          img = this.images.left;
          ctx.drawImage(img, this.x, this.y, this.width * 1.5, this.height * 1.5);
        } else if (this.direction === 'right') {
          img = this.images.right;
          ctx.drawImage(img, this.x, this.y, this.width * 1.5, this.height * 1.5);
        } else {
          img = this.images.forward;
          ctx.drawImage(img, this.x, this.y, this.width, this.height);
        }
      }
      activateBoost() {
        let duration = this.steeze * 1000; // boost lasts steeze seconds
        if (!this.boostActive) {
          this.speed *= 1.33;
          this.boostActive = true;
          this.boostEndTime = Date.now() + duration;
          console.log("Speed boost activated for", duration, "ms");
        }
      }
    }

    class Tree {
      constructor(x, y, width, height, image) {
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
        this.image = image;
      }
      update(scrollSpeed) {
        this.y -= scrollSpeed;
        if (this.y < -this.height) {
          this.y = ch + Math.random() * (10 * ch);
          this.x = Math.random() * (cw - this.width);
        }
      }
      draw(ctx) { ctx.drawImage(this.image, this.x, this.y, this.width, this.height); }
    }

    class Snowman {
      constructor(x, y, width, height, images) {
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
        this.images = images;
        this.hit = false;
      }
      update(scrollSpeed) { this.y -= scrollSpeed; }
      draw(ctx) {
        const img = this.hit ? this.images.hit : this.images.intact;
        ctx.drawImage(img, this.x, this.y, this.width, this.height);
      }
    }

    class MurderTree {
      constructor(x, y, width, height, speed, image) {
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
        this.speed = speed;
        this.image = image;
        this.active = false;
      }
      update(skier) {
        if (!this.active) return;
        let speedFactor = (Math.random() < 0.05) ? 0.5 : 1.0;
        const effectiveSpeed = this.speed * speedFactor;
        let dx = skier.x - this.x;
        let dy = skier.y - this.y;
        let distance = Math.sqrt(dx * dx + dy * dy) || 1;
        this.x += (dx / distance) * effectiveSpeed;
        this.y += (dy / distance) * effectiveSpeed;
        this.x = Math.max(0, Math.min(this.x, cw - this.width));
        this.y = Math.max(0, Math.min(this.y, ch - this.height));
      }
      draw(ctx) {
        if (this.active) { ctx.drawImage(this.image, this.x, this.y, this.width, this.height); }
      }
    }

    class Boulder {
      constructor(x, y, radius, speed, image) {
        this.x = x;
        this.y = y;
        this.radius = radius;
        this.speed = speed;
        this.image = image;
      }
      update(scrollSpeed) {
        this.y += this.speed + scrollSpeed;
        if (this.y - this.radius > ch) {
          this.y = -this.radius;
          this.x = Math.random() * (cw - this.radius * 2) + this.radius;
        }
      }
      draw(ctx) {
        ctx.drawImage(this.image, this.x - this.radius, this.y - this.radius, this.radius * 2, this.radius * 2);
      }
    }

    class Jump {
      constructor(x, y, width, height) {
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
      }
      draw(ctx) {
        ctx.fillStyle = '#FFA500';
        ctx.beginPath();
        ctx.moveTo(this.x, this.y + this.height);
        ctx.lineTo(this.x + this.width, this.y + this.height);
        ctx.lineTo(this.x + this.width, this.y);
        ctx.closePath();
        ctx.fill();
      }
    }

    /* ---------------- New Stage: Serpentine Slalom ---------------- */
    // In this stage, trees form a serpentine (zigzag) path ~300px wide (10Ã— skier width).
    function createSerpentinePath(game) {
      const pathWidth = 300; // 10Ã— skier width (approx)
      const rows = 20; // how many rows of trees to fill the course
      let trees = [];
      // For each row, compute a center that oscillates
      for (let i = 0; i < rows; i++) {
        // Let center vary sinusoidally across the course
        let center = cw/2 + (cw/2 - pathWidth/2 - 20) * Math.sin( (i/rows) * Math.PI * 2 );
        // For each column, if the tree is outside the gap (center Â± pathWidth/2), add it.
        const cols = Math.floor(cw / 60);
        for (let j = 0; j < cols; j++) {
          let treeX = j * 60;
          // If treeX is outside the gap, add a tree at this row.
          if (treeX < center - pathWidth/2 || treeX > center + pathWidth/2) {
            let treeY = ch + (i * ( (ch*10) / rows )); // spread trees along the course
            trees.push(new Tree(treeX, treeY, 60, 100, game.assets.tree));
          }
        }
      }
      return trees;
    }

    /* ---------------- Main Game Class ---------------- */
    class Game {
      constructor(canvas, ctx) {
        this.canvas = canvas;
        this.ctx = ctx;
        this.state = GAME_STATES.MENU;
        this.currentStage = STAGES.STAGE1;
        this.pauseTime = 0;
        this.startTime = 0;
        this.introStartTime = 0;
        this.elapsedTime = 0;
        this.distance = 0;
        // For non-Bunny stages, course length = 10 screens; for Bunny, 3 screens.
        this.totalDistance = 10 * ch; // e.g., 10*1200 = 12000
        this.keys = { ArrowLeft: false, ArrowRight: false, ArrowUp: false, ArrowDown: false };
        this.collisionEffect = null;
        // Assets container
        this.assets = { skier: {}, tree: null, murderTree: null, snowman: {}, boulder: null };
        // Game objects
        this.skier = null;
        this.trees = [];
        this.snowmen = [];
        this.boulders = []; // for Stage 4
        this.murderTree = null;
        this.jump = null;   // for Bunny Slope Blitz
        this.snowflakes = []; // for falling snow in Stage 2
        // Finish line (checkerboard)
        this.finishLine = { y: -this.totalDistance, width: cw, height: 40 };
        // Audio references
        this.audio = {
          title: document.getElementById('titleMusic'),
          stage1: document.getElementById('stage1Music'),
          stage2: document.getElementById('stage2Music'),
          stage3: document.getElementById('stage3Music')
        };
        this.bindInput();
      }
      bindInput() {
        document.addEventListener('keydown', (e) => {
          if (["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown"].includes(e.key)) {
            e.preventDefault();
          }
          if (this.keys.hasOwnProperty(e.key)) {
            this.keys[e.key] = true;
          } else if (e.key === 'p') { this.togglePause(); }
        });
        document.addEventListener('keyup', (e) => {
          if (this.keys.hasOwnProperty(e.key)) {
            this.keys[e.key] = false;
          }
        });
      }
      async preloadAssets() {
        console.log("Preloading assets...");
        const players = ['ryan', 'alex', 'mitch', 'jeremy'];
        for (const name of players) {
          this.assets.skier[name] = {
            left: await loadImage(`${name}-left.png`),
            right: await loadImage(`${name}-right.png`),
            forward: await loadImage(`${name}-forward.png`)
          };
          console.log(`Loaded skier images for ${name}`);
        }
        this.assets.tree = await loadImage('tree.png');
        console.log("Loaded tree image");
        this.assets.murderTree = await loadImage('murder-tree.png');
        console.log("Loaded murder tree image");
        this.assets.snowman = {
          intact: await loadImage('snowman-intact.png'),
          hit: await loadImage('snowman-hit.png')
        };
        console.log("Loaded snowman images");
        this.assets.boulder = await loadImage('boulder.png');
        console.log("Loaded boulder image");
      }
      initGameObjects(selectedPlayer) {
        console.log("Initializing game objects for player:", selectedPlayer);
        // Create the skier; position near top center.
        this.skier = new Skier(cw/2 - 20, 100, 30, 60, this.assets.skier[selectedPlayer]);
        // Set stats based on characterStats.
        this.skier.baseSpeed = 6 * characterStats[selectedPlayer].speedMultiplier;
        this.skier.speed = this.skier.baseSpeed;
        this.skier.stamina = characterStats[selectedPlayer].stamina;
        this.skier.steeze = characterStats[selectedPlayer].steeze;
        this.skier.lastHitTime = 0;
        this.distance = 0;
        this.collisionEffect = null;
        // Set course length
        if (this.currentStage === STAGES.BUNNY) {
          this.totalDistance = 3 * ch;
          this.finishLine.y = -this.totalDistance;
        } else {
          this.totalDistance = 10 * ch;
          this.finishLine.y = -this.totalDistance;
        }
        // Create obstacles based on stage.
        if (this.currentStage === STAGES.STAGE1) {  // Forest Frenzy
          this.trees = [];
          for (let i = 0; i < 20; i++) {
            let treeX = Math.random() * (cw - 60);
            let treeY = Math.random() * (10 * ch) + ch;
            this.trees.push(new Tree(treeX, treeY, 60, 80, this.assets.tree));
          }
          this.murderTree = new MurderTree(Math.random() * (cw - 45), ch + 100, 45, 75, 4.5, this.assets.murderTree);
        } else if (this.currentStage === STAGES.STAGE2) {  // Winter Wonderland
          this.trees = [];
          const rows = 10;
          const cols = Math.floor(cw / 60);
          for (let i = 0; i < rows; i++) {
            let gapIndex = Math.floor(Math.random() * (cols - 1));
            for (let j = 0; j < cols; j++) {
              if (j !== gapIndex && j !== gapIndex + 1) {
                this.trees.push(new Tree(j * 60, ch * i, 60, 100, this.assets.tree));
              }
            }
          }
          this.murderTree = new MurderTree(Math.random() * (cw - 45), ch + 100, 45, 75, 4.5, this.assets.murderTree);
          // Increase snow density
          this.snowflakes = [];
          for (let i = 0; i < 67; i++) {
            let x = Math.random() * cw;
            let y = Math.random() * ch;
            let size = Math.random() * 2 + 1;
            let speed = Math.random() * 1 + 0.5;
            let drift = Math.random() * 0.5 - 0.25;
            this.snowflakes.push(new SnowFlake(x, y, size, speed, drift));
          }
        } else if (this.currentStage === STAGES.STAGE3) {  // Mountain Madness
          this.trees = [];
          let pathX = cw/2 - 2.5 * this.skier.width;
          const rows = 10;
          const cols = Math.floor(cw / 60);
          for (let i = 0; i < rows; i++) {
            let curve = (Math.random() - 0.5) * 2 * this.skier.width;
            pathX = Math.max(0, Math.min(pathX + curve, cw - 5 * this.skier.width));
            for (let j = 0; j < cols; j++) {
              if (j * 60 < pathX || j * 60 > pathX + 5 * this.skier.width) {
                this.trees.push(new Tree(j * 60, ch * i, 60, 100, this.assets.tree));
              }
            }
          }
          this.murderTree = new MurderTree(Math.random() * (cw - 45), ch + 100, 45, 75, 4.5, this.assets.murderTree);
        } else if (this.currentStage === STAGES.STAGE4) {  // Rockslide Rumble
          this.boulders = [];
          for (let i = 0; i < 10; i++) {
            let boulderX = Math.random() * (cw - 40) + 20;
            let boulderY = Math.random() * -ch;
            this.boulders.push(new Boulder(boulderX, boulderY, 20, 2, this.assets.boulder));
          }
          this.murderTree = new MurderTree(Math.random() * (cw - 45), ch + 100, 45, 75, 4.5, this.assets.murderTree);
        } else if (this.currentStage === STAGES.BUNNY) {  // Bunny Slope Blitz
          this.trees = [];
          const rows = 5;
          const cols = Math.floor(cw / 60);
          for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) {
              if (j % 2 === 0) {
                this.trees.push(new Tree(j * 60, ch * i, 60, 100, this.assets.tree));
              }
            }
          }
          this.murderTree = null;
          this.jump = new Jump(cw/2 - 50, this.finishLine.y + 50, 100, 20);
        } else if (this.currentStage === STAGES.SERPENTINE) {  // Serpentine Slalom
          // Create a serpentine path that is ~300px wide (10Ã— skier width)
          this.trees = createSerpentinePath(this);
          this.murderTree = null;
        }
        // Create snowmen (always present)
        this.snowmen = [];
        for (let i = 0; i < 3; i++) {
          let snowmanX = Math.random() * (cw - 40);
          let snowmanY = Math.random() * (10 * ch);
          this.snowmen.push(new Snowman(snowmanX, snowmanY, 40, 60, this.assets.snowman));
        }
      }
      // Process a hit â€“ reduce stamina and show "BAM!" for 1 sec, then clear.
      processHit(obstacleImage) {
        const now = Date.now();
        const cooldown = 1000; // 1 second invulnerability window
        if (now - this.skier.lastHitTime > cooldown) {
          if (this.skier.stamina > 1) {
            this.skier.stamina -= 1;
            this.skier.lastHitTime = now;
            console.log("Hit! Remaining stamina: " + this.skier.stamina);
            this.collisionEffect = { x: this.skier.x, y: this.skier.y };
            setTimeout(() => { this.collisionEffect = null; }, 1000);
          } else {
            this.state = GAME_STATES.GAME_OVER;
            showEndMenu(obstacleImage, this.elapsedTime);
          }
        }
      }
      togglePause() {
        if (this.state === GAME_STATES.PLAYING) {
          this.state = GAME_STATES.PAUSED;
          this.pauseStart = Date.now();
          console.log("Game paused");
          if (this.currentStage === STAGES.STAGE2) { this.audio.stage2.pause(); }
          else if (this.currentStage === STAGES.STAGE3) { this.audio.stage3.pause(); }
          else { this.audio.stage1.pause(); }
        } else if (this.state === GAME_STATES.PAUSED) {
          this.state = GAME_STATES.PLAYING;
          this.pauseTime += Date.now() - this.pauseStart;
          console.log("Game resumed");
          if (this.currentStage === STAGES.STAGE2) { this.audio.stage2.play(); }
          else if (this.currentStage === STAGES.STAGE3) { this.audio.stage3.play(); }
          else { this.audio.stage1.play(); }
        }
      }
      // Intro animation: skier skis down with zigzag until reaching near bottom.
      updateIntro() {
        let t = (Date.now() - this.introStartTime) / 1000; // seconds elapsed
        const totalIntro = 5; // 5-second intro
        // Use sine wave for horizontal zigzag; amplitude 200.
        let amplitude = 200;
        this.skier.x = this.introInitialX + amplitude * Math.sin(2 * Math.PI * t / 2);
        // Move from initial y to near bottom (say, 80% of ch)
        this.skier.y = this.introInitialY + ((ch - this.skier.height - this.introInitialY) * (t / totalIntro));
        if (t >= totalIntro) {
          this.state = GAME_STATES.PLAYING;
        }
      }
      update() {
        if (this.state === GAME_STATES.INTRO) {
          this.updateIntro();
          return;
        }
        this.skier.update(this.keys, cw, ch);
        this.distance += this.skier.speed;
        // Check collisions with snowmen.
        for (let snowman of this.snowmen) {
          snowman.update(this.skier.speed / 2);
          if (!snowman.hit && checkCollision(this.skier, snowman)) {
            console.log("Collision with snowman detected");
            snowman.hit = true;
            this.skier.activateBoost();
          }
        }
        // Update obstacles.
        if (this.currentStage === STAGES.STAGE1 ||
            this.currentStage === STAGES.STAGE2 ||
            this.currentStage === STAGES.STAGE3 ||
            this.currentStage === STAGES.SERPENTINE) {
          for (let tree of this.trees) {
            tree.update(this.skier.speed / 2);
            if (checkCollision(this.skier, tree)) {
              console.log("Collision with tree detected");
              this.processHit(endImages.tree);
              if (this.state === GAME_STATES.GAME_OVER) return;
            }
          }
        } else if (this.currentStage === STAGES.STAGE4) {
          for (let boulder of this.boulders) {
            boulder.update(this.skier.speed / 2);
            let box = { x: boulder.x - boulder.radius, y: boulder.y - boulder.radius, width: boulder.radius*2, height: boulder.radius*2 };
            if (checkCollision(this.skier, box)) {
              console.log("Collision with boulder detected");
              this.processHit(endImages.tree);
              if (this.state === GAME_STATES.GAME_OVER) return;
            }
          }
          if (this.murderTree.active) {
            this.murderTree.update(this.skier);
            if (checkCollision(this.skier, this.murderTree)) {
              console.log("Collision with murder tree detected");
              this.processHit(endImages.murderTree);
              if (this.state === GAME_STATES.GAME_OVER) return;
            }
          }
        } else if (this.currentStage === STAGES.BUNNY) {
          for (let tree of this.trees) {
            tree.update(this.skier.speed / 2);
            if (checkCollision(this.skier, tree)) {
              console.log("Collision with tree detected on Bunny Slope");
              this.processHit(endImages.tree);
              if (this.state === GAME_STATES.GAME_OVER) return;
            }
          }
          if (this.jump && checkCollision(this.skier, { x: this.jump.x, y: this.jump.y, width: this.jump.width, height: this.jump.height })) {
            console.log("Jump ramp reached on Bunny Slope Blitz!");
            this.state = GAME_STATES.WIN;
            showEndMenu(endImages.finish, this.elapsedTime);
            return;
          }
        }
        // Update falling snow in Stage 2.
        if (this.currentStage === STAGES.STAGE2 && this.snowflakes) {
          for (let flake of this.snowflakes) { flake.update(); }
        }
        // Update murder tree if active.
        if (this.murderTree && this.murderTree.active) {
          this.murderTree.update(this.skier);
          if (checkCollision(this.skier, this.murderTree)) {
            console.log("Collision with murder tree detected");
            this.processHit(endImages.murderTree);
            if (this.state === GAME_STATES.GAME_OVER) return;
          }
        }
        // Activate murder tree after 10 seconds.
        this.elapsedTime = Math.floor((Date.now() - this.startTime - this.pauseTime) / 1000);
        if (this.elapsedTime >= 10 && this.murderTree && !this.murderTree.active) {
          this.murderTree.active = true;
          this.murderTree.y = (this.currentStage === STAGES.STAGE3) ? -this.murderTree.height : ch;
          console.log("Murder tree activated");
        }
        // Win condition: when distance reaches totalDistance (except Bunny stage).
        if (this.distance >= this.totalDistance && this.currentStage !== STAGES.BUNNY) {
          console.log("Win condition reached");
          this.state = GAME_STATES.WIN;
          showEndMenu(endImages.finish, this.elapsedTime);
        }
      }
      drawFinishLine() {
        for (let i = 0; i < cw / 20; i++) {
          for (let j = 0; j < this.finishLine.height / 20; j++) {
            this.ctx.fillStyle = ((i + j) % 2 === 0) ? 'black' : 'white';
            this.ctx.fillRect(i * 20, this.finishLine.y + j * 20, 20, 20);
          }
        }
      }
      drawProgressBar() {
        let progress = Math.min(1, this.distance / this.totalDistance);
        document.getElementById('progressBar').style.width = (progress * 100) + '%';
      }
      drawScene() {
        this.ctx.clearRect(0, 0, cw, ch);
        this.drawFinishLine();
        if (this.currentStage === STAGES.STAGE2 && this.snowflakes) {
          for (let flake of this.snowflakes) { flake.draw(this.ctx); }
        }
        for (let snowman of this.snowmen) { snowman.draw(this.ctx); }
        if (this.currentStage !== STAGES.STAGE4 && this.currentStage !== STAGES.BUNNY && this.currentStage !== STAGES.SERPENTINE) {
          for (let tree of this.trees) { tree.draw(this.ctx); }
        } else if (this.currentStage === STAGES.STAGE4) {
          for (let boulder of this.boulders) { boulder.draw(this.ctx); }
        } else if (this.currentStage === STAGES.BUNNY) {
          for (let tree of this.trees) { tree.draw(this.ctx); }
          if (this.jump) { this.jump.draw(this.ctx); }
        } else if (this.currentStage === STAGES.SERPENTINE) {
          for (let tree of this.trees) { tree.draw(this.ctx); }
        }
        if (this.murderTree && this.murderTree.active) { this.murderTree.draw(this.ctx); }
        this.skier.draw(this.ctx);
        if (this.skier.boostActive) {
          this.ctx.fillStyle = 'black';
          this.ctx.font = '20px Arial';
          this.ctx.fillText('Speed boost!', this.skier.x, this.skier.y - 10);
        }
        if (this.collisionEffect) {
          this.ctx.fillStyle = 'red';
          this.ctx.font = '30px Arial';
          this.ctx.fillText("BAM!", this.collisionEffect.x, this.collisionEffect.y);
        }
      }
      gameLoop() {
        if (this.state === GAME_STATES.PLAYING || this.state === GAME_STATES.INTRO) {
          this.update();
        }
        this.drawScene();
        this.drawProgressBar();
        document.getElementById('timer').textContent = `Time: ${this.elapsedTime} seconds`;
        requestAnimationFrame(this.gameLoop.bind(this));
      }
      startGame(selectedPlayer) {
        console.log("Starting game for player:", selectedPlayer);
        // Show progress bar container
        document.getElementById('progressContainer').style.display = 'block';
        this.audio.title.pause();
        if (this.currentStage === STAGES.STAGE2) { this.audio.stage2.play(); }
        else if (this.currentStage === STAGES.STAGE3) { this.audio.stage3.play(); }
        else { this.audio.stage1.play(); }
        document.getElementById('pauseMenu').style.display = 'block';
        // Set up intro animation: record initial position and time.
        this.introStartTime = Date.now();
        this.introInitialX = this.skier.x;
        this.introInitialY = this.skier.y;
        this.state = GAME_STATES.INTRO;
        this.gameLoop();
      }
    }

    /* ---------------- Global Initialization ---------------- */
    const endImages = {
      tree: 'hit-tree.jpg',
      murderTree: 'murder-tree-caught.jpg',
      finish: 'stage-finished.jpg'
    };
    const canvasElem = document.getElementById('gameCanvas');
    const game = new Game(canvasElem, canvasElem.getContext('2d'));
    game.preloadAssets().then(() => {
      console.log("All assets loaded. Displaying menu.");
      document.getElementById('menu').style.display = 'block';
      canvasElem.style.display = 'none';
      game.audio.title.play();
    }).catch(err => { console.error('Error loading assets', err); });

    /* ---------------- High Score Functions ---------------- */
    function getHighScores(stageKey) {
      let scores = localStorage.getItem('highScores_' + stageKey);
      return scores ? JSON.parse(scores) : [];
    }
    function saveHighScore(stageKey, record) {
      let scores = getHighScores(stageKey);
      scores.push(record);
      scores.sort((a, b) => a.time - b.time);
      if (scores.length > 10) { scores = scores.slice(0, 10); }
      localStorage.setItem('highScores_' + stageKey, JSON.stringify(scores));
    }
    function displayHighScores(stageKey) {
      let scores = getHighScores(stageKey);
      let html = "<h3>High Scores for " + stageKey + "</h3><ol>";
      for (let rec of scores) {
        html += `<li>${rec.name} (${rec.skier}) - ${rec.time} sec</li>`;
      }
      html += "</ol>";
      document.getElementById('highScoreList').innerHTML = html;
    }

    /* ---------------- End Game Screen Helper ---------------- */
    function showEndMenu(imageSrc, elapsedTime) {
      console.log("Showing end menu:", imageSrc, "Elapsed time:", elapsedTime);
      document.getElementById('endImage').src = imageSrc;
      document.getElementById('timeTaken').textContent = `Time Taken: ${elapsedTime} seconds`;
      document.getElementById('endMenu').style.display = 'block';
      canvasElem.style.display = 'none';
      document.getElementById('progressContainer').style.display = 'none';
    }

    /* ---------------- UI Event Listeners ---------------- */
    document.getElementById('viewMovieButton').addEventListener('click', () => {
      console.log("View Intro Movie button clicked");
      document.getElementById('menu').style.display = 'none';
      document.getElementById('introMovie').style.display = 'block';
      game.audio.title.play();
      document.getElementById('introVideo').play();
    });
    document.getElementById('introVideo').addEventListener('ended', () => {
      console.log("Intro video ended");
      document.getElementById('introMovie').style.display = 'none';
      document.getElementById('menu').style.display = 'block';
    });
    document.getElementById('stage1Button').addEventListener('click', () => {
      console.log("Forest Frenzy button clicked");
      game.currentStage = STAGES.STAGE1;
      document.getElementById('menu').style.display = 'none';
      document.getElementById('playerSelect').style.display = 'block';
    });
    document.getElementById('stage2Button').addEventListener('click', () => {
      console.log("Winter Wonderland button clicked");
      game.currentStage = STAGES.STAGE2;
      document.getElementById('menu').style.display = 'none';
      document.getElementById('playerSelect').style.display = 'block';
    });
    document.getElementById('stage3Button').addEventListener('click', () => {
      console.log("Mountain Madness button clicked");
      game.currentStage = STAGES.STAGE3;
      document.getElementById('menu').style.display = 'none';
      document.getElementById('playerSelect').style.display = 'block';
    });
    document.getElementById('stage4Button').addEventListener('click', () => {
      console.log("Rockslide Rumble button clicked");
      game.currentStage = STAGES.STAGE4;
      document.getElementById('menu').style.display = 'none';
      document.getElementById('playerSelect').style.display = 'block';
    });
    document.getElementById('bunnyButton').addEventListener('click', () => {
      console.log("Bunny Slope Blitz button clicked");
      game.currentStage = STAGES.BUNNY;
      document.getElementById('menu').style.display = 'none';
      document.getElementById('playerSelect').style.display = 'block';
    });
    document.getElementById('serpentineButton').addEventListener('click', () => {
      console.log("Serpentine Slalom button clicked");
      game.currentStage = STAGES.SERPENTINE;
      document.getElementById('menu').style.display = 'none';
      document.getElementById('playerSelect').style.display = 'block';
    });
    // Soundtrack menu handling.
    document.getElementById('soundtrackButton').addEventListener('click', () => {
      console.log("Soundtrack button clicked");
      document.getElementById('menu').style.display = 'none';
      document.getElementById('soundtrackMenu').style.display = 'block';
    });
    document.getElementById('backToMenuFromSoundtrack').addEventListener('click', () => {
      console.log("Back to menu from soundtrack");
      document.getElementById('soundtrackMenu').style.display = 'none';
      document.getElementById('menu').style.display = 'block';
    });
    document.getElementById('playTitleMusic').addEventListener('click', () => {
      game.audio.stage1.pause();
      game.audio.stage2.pause();
      game.audio.stage3.pause();
      game.audio.title.currentTime = 0;
      game.audio.title.play();
    });
    document.getElementById('playStage1Music').addEventListener('click', () => {
      game.audio.title.pause();
      game.audio.stage2.pause();
      game.audio.stage3.pause();
      game.audio.stage1.currentTime = 0;
      game.audio.stage1.play();
    });
    document.getElementById('playStage2Music').addEventListener('click', () => {
      game.audio.title.pause();
      game.audio.stage1.pause();
      game.audio.stage3.pause();
      game.audio.stage2.currentTime = 0;
      game.audio.stage2.play();
    });
    document.getElementById('playStage3Music').addEventListener('click', () => {
      game.audio.title.pause();
      game.audio.stage1.pause();
      game.audio.stage2.pause();
      game.audio.stage3.currentTime = 0;
      game.audio.stage3.play();
    });
    // Character selection buttons.
    document.getElementById('player1Button').addEventListener('click', () => {
      console.log("Player Ryan selected");
      canvasElem.style.display = 'block';
      document.getElementById('playerSelect').style.display = 'none';
      game.initGameObjects('ryan');
      game.startGame('ryan');
    });
    document.getElementById('player2Button').addEventListener('click', () => {
      console.log("Player Alex selected");
      canvasElem.style.display = 'block';
      document.getElementById('playerSelect').style.display = 'none';
      game.initGameObjects('alex');
      game.startGame('alex');
    });
    document.getElementById('player3Button').addEventListener('click', () => {
      console.log("Player Mitch selected");
      canvasElem.style.display = 'block';
      document.getElementById('playerSelect').style.display = 'none';
      game.initGameObjects('mitch');
      game.startGame('mitch');
    });
    document.getElementById('player4Button').addEventListener('click', () => {
      console.log("Player Jeremy selected");
      canvasElem.style.display = 'block';
      document.getElementById('playerSelect').style.display = 'none';
      game.initGameObjects('jeremy');
      game.startGame('jeremy');
    });
    document.getElementById('pauseButton').addEventListener('click', () => {
      console.log("Pause button clicked");
      game.togglePause();
    });
    document.getElementById('restartButton').addEventListener('click', () => {
      console.log("Restart button clicked");
      location.reload();
    });
    document.getElementById('submitScoreButton').addEventListener('click', () => {
      const name = document.getElementById('playerName').value || "Anonymous";
      const record = {
        name: name,
        skier: (game.skier.images === game.assets.skier.ryan) ? "Ryan" :
               (game.skier.images === game.assets.skier.alex) ? "Alex" :
               (game.skier.images === game.assets.skier.mitch) ? "Mitch" : "Jeremy",
        time: game.elapsedTime
      };
      let stageKey;
      switch(game.currentStage) {
        case STAGES.STAGE1: stageKey = "ForestFrenzy"; break;
        case STAGES.STAGE2: stageKey = "WinterWonderland"; break;
        case STAGES.STAGE3: stageKey = "MountainMadness"; break;
        case STAGES.STAGE4: stageKey = "RockslideRumble"; break;
        case STAGES.BUNNY: stageKey = "BunnySlopeBlitz"; break;
        case STAGES.SERPENTINE: stageKey = "SerpentineSlalom"; break;
      }
      saveHighScore(stageKey, record);
      displayHighScores(stageKey);
    });
    document.getElementById('viewHighScoresButton').addEventListener('click', () => {
      let stageKey;
      switch(game.currentStage) {
        case STAGES.STAGE1: stageKey = "ForestFrenzy"; break;
        case STAGES.STAGE2: stageKey = "WinterWonderland"; break;
        case STAGES.STAGE3: stageKey = "MountainMadness"; break;
        case STAGES.STAGE4: stageKey = "RockslideRumble"; break;
        case STAGES.BUNNY: stageKey = "BunnySlopeBlitz"; break;
        case STAGES.SERPENTINE: stageKey = "SerpentineSlalom"; break;
      }
      displayHighScores(stageKey);
    });
  </script>
</body>
</html>
