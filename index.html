<!DOCTYPE html>
<html>
<head>
  <title>Ryan Simmons' Glade Runner 2</title>
  <style>
    body {
      margin: 0;
      background-color: #f0f0f0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    /* Make the canvas responsive */
    canvas {
      background: #fff;
      border: 5px solid #333;
      margin-top: 20px;
    }
    /* Improved button styling */
    button {
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 15px 32px;
      margin: 10px;
      font-size: 18px;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: background-color 0.3s, transform 0.2s;
    }
    button:hover {
      background-color: #45a049;
      transform: scale(1.02);
    }
    #menu, #playerSelect, #endMenu, #pauseMenu, #introMovie, #highScorePanel {
      text-align: center;
      margin-top: 20px;
    }
    #playerSelect div {
      display: inline-block;
      margin: 0 20px;
    }
    #playerSelect img {
      width: 100px;
      height: 100px;
      display: block;
      margin: 0 auto 10px;
    }
    #timer {
      font-size: 24px;
      margin-top: 10px;
    }
    /* High score input styling */
    #highScorePanel input[type="text"] {
      padding: 8px;
      font-size: 16px;
      width: 200px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #highScorePanel button {
      padding: 8px 16px;
      font-size: 16px;
    }
    #highScoreList {
      margin-top: 10px;
      text-align: left;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
  </style>
</head>
<body>
  <!-- Menu UI -->
  <div id="menu">
    <img id="titleImage" src="title-screen.png" alt="Title Screen">
    <br>
    <button id="viewMovieButton">View Intro Movie</button>
    <br>
    <!-- Stage selection buttons -->
    <button id="stage1Button">Stage 1</button>
    <button id="stage2Button">Stage 2</button>
    <button id="stage3Button">Stage 3</button>
    <button id="stage4Button">Falling Boulders</button>
    <button id="bunnyButton">Bunny Slope</button>
  </div>
  
  <!-- Character selection UI -->
  <div id="playerSelect" style="display:none;">
    <h2>Select Your Skier</h2>
    <div>
      <img id="ryanRight" src="ryan-right.png" alt="Ryan">
      <button id="player1Button">Ryan</button>
    </div>
    <div>
      <img id="alexRight" src="alex-right.png" alt="Alex">
      <button id="player2Button">Alex</button>
    </div>
    <div>
      <img id="mitchRight" src="mitch-right.png" alt="Mitch">
      <button id="player3Button">Mitch</button>
    </div>
  </div>
  
  <div id="pauseMenu" style="display:none;">
    <button id="pauseButton">Pause</button>
  </div>
  
  <div id="endMenu" style="display:none;">
    <p id="timeTaken"></p>
    <img id="endImage" src="" alt="End Image"><br>
    <!-- High score entry panel -->
    <div id="highScorePanel">
      <input type="text" id="playerName" placeholder="Enter your name">
      <button id="submitScoreButton">Submit Score</button>
      <br>
      <button id="viewHighScoresButton">View High Scores</button>
    </div>
    <div id="highScoreList"></div>
    <br>
    <button id="restartButton">Restart Game</button>
  </div>
  
  <div id="introMovie" style="display:none;">
    <video id="introVideo" width="800" height="600" controls>
      <source src="intro-movie.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>
  
  <!-- The canvas will be resized via JavaScript -->
  <canvas id="gameCanvas" style="display:none;"></canvas>
  <div id="timer">Time: 0 seconds</div>

  <!-- Audio Elements -->
  <audio id="titleMusic" loop>
    <source src="Escape_the_Murder_Tree.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  <audio id="stage1Music" loop>
    <source src="Murder_Tree_Behind_You.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  <audio id="stage2Music" loop>
    <source src="Murder_Tree_Breakdown.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  <audio id="stage3Music" loop>
    <source src="stage3-music.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <script>
    console.log("Script loaded");

    /* ---------------- Canvas Resize ---------------- */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    function resizeCanvas() {
      canvas.width = window.innerWidth * 0.9;
      canvas.height = window.innerHeight * 0.8;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    /* ---------------- Constants & Helpers ---------------- */
    const GAME_STATES = {
      MENU: 'menu',
      PLAYER_SELECT: 'player_select',
      PLAYING: 'playing',
      PAUSED: 'paused',
      GAME_OVER: 'game_over',
      WIN: 'win'
    };

    // Stage IDs: 1-4 as before, 5 for Bunny Slope
    const STAGES = {
      STAGE1: 1,
      STAGE2: 2,
      STAGE3: 3,
      STAGE4: 4,
      BUNNY: 5
    };

    // AABB collision check
    function checkCollision(a, b) {
      return a.x < b.x + b.width &&
             a.x + a.width > b.x &&
             a.y < b.y + b.height &&
             a.y + a.height > b.y;
    }

    // Load image with Promise
    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          console.log(`Loaded image: ${src}`);
          resolve(img);
        };
        img.onerror = () => {
          console.error(`Error loading image: ${src}`);
          reject();
        };
        img.src = src;
      });
    }

    /* ---------------- Entity Classes ---------------- */
    class Skier {
      constructor(x, y, width, height, images) {
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
        this.baseSpeed = 6;
        this.speed = this.baseSpeed;
        this.direction = 'forward';
        this.images = images; // { left, right, forward }
        this.boostActive = false;
        this.boostEndTime = 0;
      }
      update(keys, canvasWidth, canvasHeight) {
        if (keys.ArrowLeft) { this.x -= this.speed; this.direction = 'left'; }
        if (keys.ArrowRight) { this.x += this.speed; this.direction = 'right'; }
        if (keys.ArrowUp) { this.y -= this.speed; this.direction = 'forward'; }
        if (keys.ArrowDown) { this.y += this.speed; this.direction = 'forward'; }
        // Constrain within canvas
        this.x = Math.max(0, Math.min(this.x, canvasWidth - this.width));
        this.y = Math.max(0, Math.min(this.y, canvasHeight - this.height));
        // Boost expiration
        if (this.boostActive && Date.now() > this.boostEndTime) {
          this.speed = this.baseSpeed;
          this.boostActive = false;
          console.log("Speed boost ended");
        }
      }
      draw(ctx) {
        let img;
        if (this.direction === 'left') {
          img = this.images.left;
          ctx.drawImage(img, this.x, this.y, this.width * 1.5, this.height * 1.5);
        } else if (this.direction === 'right') {
          img = this.images.right;
          ctx.drawImage(img, this.x, this.y, this.width * 1.5, this.height * 1.5);
        } else {
          img = this.images.forward;
          ctx.drawImage(img, this.x, this.y, this.width, this.height);
        }
      }
      activateBoost(duration) {
        if (!this.boostActive) {
          this.speed *= 1.33;
          this.boostActive = true;
          this.boostEndTime = Date.now() + duration;
          console.log("Speed boost activated for", duration, "ms");
        }
      }
    }

    class Tree {
      constructor(x, y, width, height, image, canvasHeight) {
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
        this.image = image;
        this.canvasHeight = canvasHeight;
      }
      update(scrollSpeed) {
        this.y -= scrollSpeed;
        if (this.y < -this.height) {
          this.y = this.canvasHeight + Math.random() * this.canvasHeight * 9;
          this.x = Math.random() * (canvas.width - this.width);
        }
      }
      draw(ctx) { ctx.drawImage(this.image, this.x, this.y, this.width, this.height); }
    }

    class Snowman {
      constructor(x, y, width, height, images, canvasHeight) {
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
        this.images = images; // { intact, hit }
        this.hit = false;
        this.canvasHeight = canvasHeight;
      }
      update(scrollSpeed) { this.y -= scrollSpeed; }
      draw(ctx) {
        const img = this.hit ? this.images.hit : this.images.intact;
        ctx.drawImage(img, this.x, this.y, this.width, this.height);
      }
    }

    class MurderTree {
      constructor(x, y, width, height, speed, image, canvasWidth, canvasHeight) {
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
        this.speed = speed;
        this.image = image;
        this.active = false;
        this.canvasWidth = canvasWidth;
        this.canvasHeight = canvasHeight;
      }
      update(skier, stage) {
        if (!this.active) return;
        // Occasionally slow down: 5% chance to move at half-speed this frame.
        let speedFactor = (Math.random() < 0.05) ? 0.5 : 1.0;
        const effectiveSpeed = this.speed * speedFactor;
        let dx = skier.x - this.x;
        let dy = skier.y - this.y;
        let distance = Math.sqrt(dx * dx + dy * dy) || 1;
        this.x += (dx / distance) * effectiveSpeed;
        this.y += (dy / distance) * effectiveSpeed;
        // Clamp within canvas
        this.x = Math.max(0, Math.min(this.x, this.canvasWidth - this.width));
        this.y = Math.max(0, Math.min(this.y, this.canvasHeight - this.height));
      }
      draw(ctx) {
        if (this.active) { ctx.drawImage(this.image, this.x, this.y, this.width, this.height); }
      }
    }

    // New obstacle for Stage 4: Boulder drawn with an image.
    class Boulder {
      constructor(x, y, radius, speed, image) {
        this.x = x;
        this.y = y;
        this.radius = radius;
        this.speed = speed;
        this.image = image;
      }
      update(scrollSpeed) {
        // Fall downward (plus scroll)
        this.y += this.speed + scrollSpeed;
        if (this.y - this.radius > canvas.height) {
          this.y = -this.radius;
          this.x = Math.random() * (canvas.width - this.radius * 2) + this.radius;
        }
      }
      draw(ctx) {
        // Draw the boulder image centered at (x, y)
        ctx.drawImage(this.image, this.x - this.radius, this.y - this.radius, this.radius * 2, this.radius * 2);
      }
    }

    // New object for Bunny Slope: a jump ramp.
    class Jump {
      constructor(x, y, width, height) {
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
      }
      draw(ctx) {
        ctx.fillStyle = '#FFA500';
        ctx.beginPath();
        ctx.moveTo(this.x, this.y + this.height);
        ctx.lineTo(this.x + this.width, this.y + this.height);
        ctx.lineTo(this.x + this.width, this.y);
        ctx.closePath();
        ctx.fill();
      }
    }

    /* ---------------- Main Game Class ---------------- */
    class Game {
      constructor(canvas, ctx) {
        this.canvas = canvas;
        this.ctx = ctx;
        this.state = GAME_STATES.MENU;
        this.currentStage = STAGES.STAGE1;
        this.pauseTime = 0;
        this.startTime = 0;
        this.elapsedTime = 0;
        this.distance = 0;
        this.totalDistance = 10 * this.canvas.height; // for progress bar
        this.keys = { ArrowLeft: false, ArrowRight: false, ArrowUp: false, ArrowDown: false };
        this.collisionEffect = null; // for "BAM!" animation
        // Asset containers
        this.assets = { skier: {}, tree: null, murderTree: null, snowman: {}, boulder: null };
        // Game objects
        this.skier = null;
        this.trees = [];
        this.snowmen = [];
        this.boulders = [];  // for Stage 4
        this.murderTree = null;
        this.jump = null;    // for Bunny Slope
        // Finish line (checkerboard)
        this.finishLine = { y: -10 * this.canvas.height, width: this.canvas.width, height: 40 };
        // Audio references
        this.audio = {
          title: document.getElementById('titleMusic'),
          stage1: document.getElementById('stage1Music'),
          stage2: document.getElementById('stage2Music'),
          stage3: document.getElementById('stage3Music')
        };
        this.bindInput();
      }
      bindInput() {
        document.addEventListener('keydown', (e) => {
          if (["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown"].includes(e.key)) {
            e.preventDefault();
          }
          if (this.keys.hasOwnProperty(e.key)) {
            this.keys[e.key] = true;
          } else if (e.key === 'p') { this.togglePause(); }
        });
        document.addEventListener('keyup', (e) => {
          if (this.keys.hasOwnProperty(e.key)) {
            this.keys[e.key] = false;
          }
        });
      }
      async preloadAssets() {
        console.log("Preloading assets...");
        const players = ['ryan', 'alex', 'mitch'];
        for (const name of players) {
          this.assets.skier[name] = {
            left: await loadImage(`${name}-left.png`),
            right: await loadImage(`${name}-right.png`),
            forward: await loadImage(`${name}-forward.png`)
          };
          console.log(`Loaded skier images for ${name}`);
        }
        this.assets.tree = await loadImage('tree.png');
        console.log("Loaded tree image");
        this.assets.murderTree = await loadImage('murder-tree.png');
        console.log("Loaded murder tree image");
        this.assets.snowman = {
          intact: await loadImage('snowman-intact.png'),
          hit: await loadImage('snowman-hit.png')
        };
        console.log("Loaded snowman images");
        // Load boulder image for Stage 4
        this.assets.boulder = await loadImage('boulder.png');
        console.log("Loaded boulder image");
      }
      initGameObjects(selectedPlayer) {
        console.log("Initializing game objects for player:", selectedPlayer);
        // Create the skier
        this.skier = new Skier(this.canvas.width/2 - 20, 100, 30, 60, this.assets.skier[selectedPlayer]);
        // Reset progress and finish line
        this.distance = 0;
        this.finishLine.y = -10 * this.canvas.height;
        this.collisionEffect = null;
        // Create obstacles based on stage
        if (this.currentStage === STAGES.STAGE1) {
          // 20 random trees
          this.trees = [];
          for (let i = 0; i < 20; i++) {
            const treeX = Math.random() * (this.canvas.width - 60);
            const treeY = Math.random() * this.canvas.height * 10 + this.canvas.height;
            this.trees.push(new Tree(treeX, treeY, 60, 80, this.assets.tree, this.canvas.height));
          }
          // Always include murder tree for Stage 1-3 & 4 (except Bunny)
          this.murderTree = new MurderTree(
            Math.random() * (this.canvas.width - 45),
            this.canvas.height + 100,
            45, 75, 4.5,
            this.assets.murderTree,
            this.canvas.width, this.canvas.height
          );
        } else if (this.currentStage === STAGES.STAGE2) {
          // Rows of trees with gaps
          this.trees = [];
          const rows = 10;
          const cols = Math.floor(this.canvas.width / 60);
          for (let i = 0; i < rows; i++) {
            const gapIndex = Math.floor(Math.random() * (cols - 1));
            for (let j = 0; j < cols; j++) {
              if (j !== gapIndex && j !== gapIndex + 1) {
                this.trees.push(new Tree(j * 60, this.canvas.height * i, 60, 100, this.assets.tree, this.canvas.height));
              }
            }
          }
          this.murderTree = new MurderTree(
            Math.random() * (this.canvas.width - 45),
            this.canvas.height + 100,
            45, 75, 4.5,
            this.assets.murderTree,
            this.canvas.width, this.canvas.height
          );
        } else if (this.currentStage === STAGES.STAGE3) {
          // Curving narrow path
          this.trees = [];
          let pathX = this.canvas.width/2 - 2.5 * this.skier.width;
          const rows = 10;
          const cols = Math.floor(this.canvas.width / 60);
          for (let i = 0; i < rows; i++) {
            const curve = (Math.random() - 0.5) * 2 * this.skier.width;
            pathX = Math.max(0, Math.min(pathX + curve, this.canvas.width - 5 * this.skier.width));
            for (let j = 0; j < cols; j++) {
              if (j * 60 < pathX || j * 60 > pathX + 5 * this.skier.width) {
                this.trees.push(new Tree(j * 60, this.canvas.height * i, 60, 100, this.assets.tree, this.canvas.height));
              }
            }
          }
          this.murderTree = new MurderTree(
            Math.random() * (this.canvas.width - 45),
            this.canvas.height + 100,
            45, 75, 4.5,
            this.assets.murderTree,
            this.canvas.width, this.canvas.height
          );
        } else if (this.currentStage === STAGES.STAGE4) {
          // Stage with falling boulders instead of trees
          this.boulders = [];
          for (let i = 0; i < 10; i++) {
            let boulderX = Math.random() * (this.canvas.width - 40) + 20;
            let boulderY = Math.random() * -this.canvas.height; // start above
            this.boulders.push(new Boulder(boulderX, boulderY, 20, 2, this.assets.boulder));
          }
          this.murderTree = new MurderTree(
            Math.random() * (this.canvas.width - 45),
            this.canvas.height + 100,
            45, 75, 4.5,
            this.assets.murderTree,
            this.canvas.width, this.canvas.height
          );
        } else if (this.currentStage === STAGES.BUNNY) {
          // Bunny Slope: Only trees and a jump ramp at the end; no murder tree.
          this.trees = [];
          // Create a few rows of trees
          const rows = 5;
          const cols = Math.floor(this.canvas.width / 60);
          for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) {
              // Leave gaps for the "bunny" path
              if (j % 2 === 0) {
                this.trees.push(new Tree(j * 60, this.canvas.height * i, 60, 100, this.assets.tree, this.canvas.height));
              }
            }
          }
          // No murder tree in Bunny Slope
          this.murderTree = null;
          // Place a jump ramp near the finish line (use finishLine.y + some offset)
          this.jump = new Jump(this.canvas.width/2 - 50, this.finishLine.y + 50, 100, 20);
        }
        // Create snowmen (present in all stages)
        this.snowmen = [];
        for (let i = 0; i < 3; i++) {
          const snowmanX = Math.random() * (this.canvas.width - 40);
          const snowmanY = Math.random() * this.canvas.height * 10;
          this.snowmen.push(new Snowman(snowmanX, snowmanY, 40, 60, this.assets.snowman, this.canvas.height));
        }
      }
      togglePause() {
        if (this.state === GAME_STATES.PLAYING) {
          this.state = GAME_STATES.PAUSED;
          this.pauseStart = Date.now();
          console.log("Game paused");
          if (this.currentStage === STAGES.STAGE2) { this.audio.stage2.pause(); }
          else if (this.currentStage === STAGES.STAGE3) { this.audio.stage3.pause(); }
          else { this.audio.stage1.pause(); }
        } else if (this.state === GAME_STATES.PAUSED) {
          this.state = GAME_STATES.PLAYING;
          this.pauseTime += Date.now() - this.pauseStart;
          console.log("Game resumed");
          if (this.currentStage === STAGES.STAGE2) { this.audio.stage2.play(); }
          else if (this.currentStage === STAGES.STAGE3) { this.audio.stage3.play(); }
          else { this.audio.stage1.play(); }
        }
      }
      update() {
        // Update skier and finish line
        this.skier.update(this.keys, this.canvas.width, this.canvas.height);
        this.finishLine.y -= this.skier.speed / 2;
        this.distance += this.skier.speed;
        // Update snowmen
        for (let snowman of this.snowmen) {
          snowman.update(this.skier.speed / 2);
          if (!snowman.hit && checkCollision(this.skier, snowman)) {
            console.log("Collision with snowman detected");
            snowman.hit = true;
            this.skier.activateBoost(3000);
          }
        }
        // Update obstacles based on stage
        if (this.currentStage !== STAGES.STAGE4 && this.currentStage !== STAGES.BUNNY) {
          for (let tree of this.trees) {
            tree.update(this.skier.speed / 2);
            if (checkCollision(this.skier, tree)) {
              console.log("Collision with tree detected");
              if (!this.collisionEffect) {
                this.collisionEffect = { x: this.skier.x, y: this.skier.y };
                setTimeout(() => { showEndMenu(endImages.tree, this.elapsedTime); }, 300);
              }
              return;
            }
          }
        } else if (this.currentStage === STAGES.STAGE4) {
          for (let boulder of this.boulders) {
            boulder.update(this.skier.speed / 2);
            let boulderBox = { x: boulder.x - boulder.radius, y: boulder.y - boulder.radius, width: boulder.radius * 2, height: boulder.radius * 2 };
            if (checkCollision(this.skier, boulderBox)) {
              console.log("Collision with boulder detected");
              if (!this.collisionEffect) {
                this.collisionEffect = { x: this.skier.x, y: this.skier.y };
                setTimeout(() => { showEndMenu(endImages.tree, this.elapsedTime); }, 300);
              }
              return;
            }
          }
          // Also update murder tree in Stage 4
          if (this.murderTree.active) {
            this.murderTree.update(this.skier, this.currentStage);
            if (checkCollision(this.skier, this.murderTree)) {
              console.log("Collision with murder tree detected");
              if (!this.collisionEffect) {
                this.collisionEffect = { x: this.skier.x, y: this.skier.y };
                setTimeout(() => { showEndMenu(endImages.murderTree, this.elapsedTime); }, 300);
              }
              return;
            }
          }
        } else if (this.currentStage === STAGES.BUNNY) {
          // In Bunny Slope, update trees and the jump ramp.
          for (let tree of this.trees) {
            tree.update(this.skier.speed / 2);
            if (checkCollision(this.skier, tree)) {
              console.log("Collision with tree detected on Bunny Slope");
              if (!this.collisionEffect) {
                this.collisionEffect = { x: this.skier.x, y: this.skier.y };
                setTimeout(() => { showEndMenu(endImages.tree, this.elapsedTime); }, 300);
              }
              return;
            }
          }
          // Check for collision with the jump ramp
          if (this.jump && checkCollision(this.skier, { x: this.jump.x, y: this.jump.y, width: this.jump.width, height: this.jump.height })) {
            console.log("Jump ramp reached on Bunny Slope!");
            // For Bunny Slope, reaching the jump counts as a win
            showEndMenu(endImages.finish, this.elapsedTime);
            this.state = GAME_STATES.WIN;
            return;
          }
        }
        // Update murder tree for stages (if applicable)
        if (this.murderTree && this.murderTree.active) {
          this.murderTree.update(this.skier, this.currentStage);
          if (checkCollision(this.skier, this.murderTree)) {
            console.log("Collision with murder tree detected");
            if (!this.collisionEffect) {
              this.collisionEffect = { x: this.skier.x, y: this.skier.y };
              setTimeout(() => { showEndMenu(endImages.murderTree, this.elapsedTime); }, 300);
            }
            return;
          }
        }
        // Activate murder tree after 10 seconds (for stages that have it)
        this.elapsedTime = Math.floor((Date.now() - this.startTime - this.pauseTime) / 1000);
        if (this.elapsedTime >= 10 && this.murderTree && !this.murderTree.active) {
          this.murderTree.active = true;
          this.murderTree.y = (this.currentStage === STAGES.STAGE3) ? -this.murderTree.height : this.canvas.height;
          console.log("Murder tree activated");
        }
        // Win condition: skier passes finish line (for stages without jump)
        if (this.skier.y < this.finishLine.y + this.finishLine.height && this.currentStage !== STAGES.BUNNY) {
          console.log("Win condition reached");
          showEndMenu(endImages.finish, this.elapsedTime);
          this.state = GAME_STATES.WIN;
        }
      }
      drawFinishLine() {
        for (let i = 0; i < this.finishLine.width / 20; i++) {
          for (let j = 0; j < this.finishLine.height / 20; j++) {
            this.ctx.fillStyle = ((i + j) % 2 === 0) ? 'black' : 'white';
            this.ctx.fillRect(i * 20, this.finishLine.y + j * 20, 20, 20);
          }
        }
      }
      drawProgressBar() {
        let progress = Math.min(1, this.distance / this.totalDistance);
        const barWidth = this.canvas.width - 20;
        const barHeight = 20;
        this.ctx.fillStyle = '#ddd';
        this.ctx.fillRect(10, 10, barWidth, barHeight);
        this.ctx.fillStyle = '#4CAF50';
        this.ctx.fillRect(10, 10, barWidth * progress, barHeight);
        this.ctx.strokeStyle = '#333';
        this.ctx.lineWidth = 2;
        this.ctx.strokeRect(10, 10, barWidth, barHeight);
      }
      drawScene() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.drawFinishLine();
        // Draw snowmen first
        for (let snowman of this.snowmen) { snowman.draw(this.ctx); }
        // Then obstacles: trees or (for Stage 4) boulders
        if (this.currentStage !== STAGES.STAGE4 && this.currentStage !== STAGES.BUNNY) {
          for (let tree of this.trees) { tree.draw(this.ctx); }
        } else if (this.currentStage === STAGES.STAGE4) {
          for (let boulder of this.boulders) { boulder.draw(this.ctx); }
        } else if (this.currentStage === STAGES.BUNNY) {
          for (let tree of this.trees) { tree.draw(this.ctx); }
          if (this.jump) { this.jump.draw(this.ctx); }
        }
        // Draw murder tree if present
        if (this.murderTree && this.murderTree.active) { this.murderTree.draw(this.ctx); }
        // Draw skier on top
        this.skier.draw(this.ctx);
        this.drawProgressBar();
        if (this.skier.boostActive) {
          this.ctx.fillStyle = 'black';
          this.ctx.font = '20px Arial';
          this.ctx.fillText('Speed boost!', this.skier.x, this.skier.y - 10);
        }
        if (this.collisionEffect) {
          this.ctx.fillStyle = 'red';
          this.ctx.font = '30px Arial';
          this.ctx.fillText("BAM!", this.collisionEffect.x, this.collisionEffect.y);
        }
      }
      gameLoop() {
        if (this.state === GAME_STATES.PLAYING) { this.update(); }
        this.drawScene();
        document.getElementById('timer').textContent = `Time: ${this.elapsedTime} seconds`;
        requestAnimationFrame(this.gameLoop.bind(this));
      }
      startGame(selectedPlayer) {
        console.log("Starting game for player:", selectedPlayer);
        this.audio.title.pause();
        if (this.currentStage === STAGES.STAGE2) { this.audio.stage2.play(); }
        else if (this.currentStage === STAGES.STAGE3) { this.audio.stage3.play(); }
        else { this.audio.stage1.play(); }
        document.getElementById('pauseMenu').style.display = 'block';
        this.startTime = Date.now();
        this.state = GAME_STATES.PLAYING;
        this.gameLoop();
      }
    }

    /* ---------------- Global Initialization ---------------- */
    const endImages = {
      tree: 'hit-tree.jpg',
      murderTree: 'murder-tree-caught.jpg',
      finish: 'stage-finished.jpg'
    };
    const game = new Game(canvas, ctx);
    game.preloadAssets().then(() => {
      console.log("All assets loaded. Displaying menu.");
      document.getElementById('menu').style.display = 'block';
      canvas.style.display = 'none';
      game.audio.title.play();
    }).catch(err => { console.error('Error loading assets', err); });

    /* ---------------- High Score Functions ---------------- */
    function getHighScores(stageKey) {
      let scores = localStorage.getItem('highScores_' + stageKey);
      return scores ? JSON.parse(scores) : [];
    }
    function saveHighScore(stageKey, record) {
      let scores = getHighScores(stageKey);
      scores.push(record);
      scores.sort((a, b) => a.time - b.time); // lower time is better
      if (scores.length > 10) { scores = scores.slice(0, 10); }
      localStorage.setItem('highScores_' + stageKey, JSON.stringify(scores));
    }
    function displayHighScores(stageKey) {
      let scores = getHighScores(stageKey);
      let html = "<h3>High Scores for " + stageKey + "</h3><ol>";
      for (let rec of scores) {
        html += `<li>${rec.name} (${rec.skier}) - ${rec.time} sec</li>`;
      }
      html += "</ol>";
      document.getElementById('highScoreList').innerHTML = html;
    }

    /* ---------------- UI Event Listeners ---------------- */
    document.getElementById('viewMovieButton').addEventListener('click', () => {
      console.log("View Intro Movie button clicked");
      document.getElementById('menu').style.display = 'none';
      document.getElementById('introMovie').style.display = 'block';
      game.audio.title.play();
      document.getElementById('introVideo').play();
    });
    document.getElementById('introVideo').addEventListener('ended', () => {
      console.log("Intro video ended");
      document.getElementById('introMovie').style.display = 'none';
      document.getElementById('menu').style.display = 'block';
    });
    document.getElementById('stage1Button').addEventListener('click', () => {
      console.log("Stage 1 button clicked");
      game.currentStage = STAGES.STAGE1;
      document.getElementById('menu').style.display = 'none';
      document.getElementById('playerSelect').style.display = 'block';
    });
    document.getElementById('stage2Button').addEventListener('click', () => {
      console.log("Stage 2 button clicked");
      game.currentStage = STAGES.STAGE2;
      document.getElementById('menu').style.display = 'none';
      document.getElementById('playerSelect').style.display = 'block';
    });
    document.getElementById('stage3Button').addEventListener('click', () => {
      console.log("Stage 3 button clicked");
      game.currentStage = STAGES.STAGE3;
      document.getElementById('menu').style.display = 'none';
      document.getElementById('playerSelect').style.display = 'block';
    });
    document.getElementById('stage4Button').addEventListener('click', () => {
      console.log("Stage 4 button clicked");
      game.currentStage = STAGES.STAGE4;
      document.getElementById('menu').style.display = 'none';
      document.getElementById('playerSelect').style.display = 'block';
    });
    document.getElementById('bunnyButton').addEventListener('click', () => {
      console.log("Bunny Slope button clicked");
      game.currentStage = STAGES.BUNNY;
      document.getElementById('menu').style.display = 'none';
      document.getElementById('playerSelect').style.display = 'block';
    });
    document.getElementById('player1Button').addEventListener('click', () => {
      console.log("Player Ryan selected");
      canvas.style.display = 'block';
      document.getElementById('playerSelect').style.display = 'none';
      game.initGameObjects('ryan');
      game.startGame('ryan');
    });
    document.getElementById('player2Button').addEventListener('click', () => {
      console.log("Player Alex selected");
      canvas.style.display = 'block';
      document.getElementById('playerSelect').style.display = 'none';
      game.initGameObjects('alex');
      game.startGame('alex');
    });
    document.getElementById('player3Button').addEventListener('click', () => {
      console.log("Player Mitch selected");
      canvas.style.display = 'block';
      document.getElementById('playerSelect').style.display = 'none';
      game.initGameObjects('mitch');
      game.startGame('mitch');
    });
    document.getElementById('pauseButton').addEventListener('click', () => {
      console.log("Pause button clicked");
      game.togglePause();
    });
    document.getElementById('restartButton').addEventListener('click', () => {
      console.log("Restart button clicked");
      location.reload();
    });
    // High score submission and view
    document.getElementById('submitScoreButton').addEventListener('click', () => {
      const name = document.getElementById('playerName').value || "Anonymous";
      const record = { name: name, skier: game.skier.images === game.assets.skier.ryan ? "Ryan" : 
                                        (game.skier.images === game.assets.skier.alex ? "Alex" : "Mitch"),
                                        time: game.elapsedTime };
      let stageKey;
      switch(game.currentStage) {
        case STAGES.STAGE1: stageKey = "STAGE1"; break;
        case STAGES.STAGE2: stageKey = "STAGE2"; break;
        case STAGES.STAGE3: stageKey = "STAGE3"; break;
        case STAGES.STAGE4: stageKey = "STAGE4"; break;
        case STAGES.BUNNY: stageKey = "BUNNY"; break;
      }
      saveHighScore(stageKey, record);
      displayHighScores(stageKey);
    });
    document.getElementById('viewHighScoresButton').addEventListener('click', () => {
      let stageKey;
      switch(game.currentStage) {
        case STAGES.STAGE1: stageKey = "STAGE1"; break;
        case STAGES.STAGE2: stageKey = "STAGE2"; break;
        case STAGES.STAGE3: stageKey = "STAGE3"; break;
        case STAGES.STAGE4: stageKey = "STAGE4"; break;
        case STAGES.BUNNY: stageKey = "BUNNY"; break;
      }
      displayHighScores(stageKey);
    });
  </script>
</body>
</html>
